# 04. 統合・開発体験 — 受入基準達成タスク

対象の受入基準
- ローカルで一連の登録後の操作（実行→表示）が 5秒以内に完了。

本タスクでは、フロント/バックエンドの同時起動、環境変数整備、接続方式の選択、クイック検証シナリオ、計測手順を用意し、5秒以内の体験を満たすための具体アクションを示す。

## 前提
- docs/tasks/01.md〜03.md の内容で `frontend` と `server` がローカル起動できること。
- Node.js 22.x / npm、Python 3.11 / pip が利用可能。

## 作業タスク

### 1) フロント/バックエンドの同時起動（ローカル）
- [ ] ルートに開発用スクリプトを追加して、両プロセスを並行起動できるようにする。
  - 例: `scripts/dev.sh`（macOS/Linux）

    ```bash
    #!/usr/bin/env bash
    set -euo pipefail
    trap 'kill 0' EXIT

    echo "[dev] starting server on :5000"
    (
      cd server
      source .venv/bin/activate
      OSRM_BASE_URL="${OSRM_BASE_URL:-https://router.project-osrm.org}" \
      MAX_LOCATIONS="${MAX_LOCATIONS:-10}" \
      TIMEOUT_CONNECT="${TIMEOUT_CONNECT:-2.5}" \
      TIMEOUT_READ="${TIMEOUT_READ:-4.0}" \
      RATE_LIMIT_RULE="${RATE_LIMIT_RULE:-60/minute}" \
      SOLVER_TIME_LIMIT_MS="${SOLVER_TIME_LIMIT_MS:-3000}" \
      python -m flask --app app.py run
    ) &

    echo "[dev] starting frontend on :5173"
    (
      cd frontend
      npm run dev
    ) &

    wait
    ```

- [ ] 実行権限を付与して起動確認：

  ```bash
  chmod +x scripts/dev.sh
  ./scripts/dev.sh
  ```

  フロントが `http://localhost:5173`、サーバが `http://localhost:5000` で動作することを確認する。

- 任意（Windows）: PowerShell スクリプトを用意するか、`concurrently` を `frontend` に導入して `npm run dev:all` で両者を起動してもよい。

### 2) 環境変数の整備（dev 用既定値）
- [ ] `server` の環境変数（開発想定の推奨値）を `.env.local.example` に明記：

  ```dotenv
  # server/.env.local.example
  OSRM_BASE_URL=https://router.project-osrm.org
  MAX_LOCATIONS=10
  TIMEOUT_CONNECT=2.5
  TIMEOUT_READ=4.0
  RATE_LIMIT_RULE=60/minute
  SOLVER_TIME_LIMIT_MS=3000
  # 任意: CORS を明示的に制限する場合（実装に合わせて使用）
  CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
  ```

  注: Flask CLI は `python-dotenv` があれば `.env`/`.flaskenv` を自動読込する。未導入の場合は `scripts/dev.sh` のように `export`/引数で指定する。

- [ ] `frontend/.env` を作成（docs/tasks/03.md と整合）：

  ```dotenv
  # frontend/.env
  VITE_API_BASE_URL=http://localhost:5000
  ```

### 3) 接続方式の選択（CORS か Vite プロキシ）
- 既定（簡易）: サーバ側 CORS を有効にし、`VITE_API_BASE_URL` は `http://localhost:5000` を指す。
  - docs/tasks/02.md の例では `CORS(app, resources={r"/api/*": {"origins": "*"}})` としているため、そのまま動作する。

- 任意（プロキシ方式）: CORS を厳格化したい場合や同一オリジンで開発したい場合、`frontend/vite.config.ts` にプロキシを設定：

  ```ts
  // frontend/vite.config.ts
  import { defineConfig } from "vite";
  import react from "@vitejs/plugin-react";

  export default defineConfig({
    plugins: [react()],
    server: {
      proxy: {
        "/api": {
          target: "http://localhost:5000",
          changeOrigin: true,
        },
      },
    },
  });
  ```

  この場合は API を相対パス（`/api/...`）で呼び出せる。`VITE_API_BASE_URL` を空にするか、`api.ts` 側で空値なら相対パスを使う分岐を入れる。

### 4) クイック検証シナリオ（東京駅 + 近隣9点）
- [ ] `README.md` に「クイック検証」セクションを追加し、以下の手順を記載：

  1. **出発点（Depot）の設定**
     - 地図上で「東京駅」の位置を探し、クリックして出発点として登録する
     - 東京駅は東京都千代田区丸の内にある主要な駅で、地図上で「東京駅」と表示されている場所を目安にする

  2. **配達先9点の登録**
     - 東京駅を中心に、地図を拡大表示する
     - 東京駅から徒歩圏内（おおよそ500m〜1km程度）の範囲で、地図上をクリックして9つの地点を登録する
     - 各地点は、東京駅の北側・南側・東側・西側など、様々な方向に散らばるように登録する
     - 正確な位置にこだわらず、東京駅周辺の近距離エリア内であれば任意の地点で問題ない

  注: このシナリオの目的は、10点規模（出発点1点 + 配達先9点）での応答時間を評価することであり、地点の正確性には依存しない。地図上で直感的にクリックして登録できることを重視する。

### 5) 5秒以内のエンドツーエンド計測とチューニング
- [ ] フロントを起動し、Depot + 9点を登録して「最適化を実行」。描画完了までの体感/計測が 5秒以内かを確認。
- [ ] 計測の目安（いずれか）
  - ブラウザ DevTools の Console に簡易計測を追加（任意）

    ```ts
    // 例: Controls.tsx の実行直前/完了後に挿入
    const t0 = performance.now();
    // 実行...
    // 結果反映直後:
    console.log(`[E2E] optimize->render: ${Math.round(performance.now() - t0)} ms`);
    ```

  - Network タブで `/api/optimize` と地図描画のタイミングを合わせて確認。

- [ ] 遅い場合の調整ポイント
  - サーバ: `SOLVER_TIME_LIMIT_MS=3000` 付近で調整、`TIMEOUT_CONNECT/READ` を短かめに設定。
  - フロント: 最適化中はボタン無効化やローディング表示（docs/tasks/03.md）を確認し、不要な再レンダリングを避ける。
  - 初回は依存のウォームアップで遅くなることがあるため、2回目も計測する。

### 6) ドキュメント更新
- [ ] `README.md` に以下を追記/整備：
  - 同時起動手順（`scripts/dev.sh` or 代替手段）
  - 必要な環境変数（`server/.env.local.example`, `frontend/.env`）
  - クイック検証シナリオ（東京駅 + 近隣9点）と 5秒基準

## 受入基準チェック
- [ ] `./scripts/dev.sh`（または同等手段）でフロント/バックエンドを同時起動できる。
- [ ] クイック検証シナリオ（10点）で「最適化を実行→地図へ描画」までが 5秒以内。

以上で、Plan の「4. 統合・開発体験」の受入基準を満たすための具体タスクを網羅する。
