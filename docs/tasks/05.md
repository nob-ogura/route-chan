# 05. デプロイ（MVP） — 受入基準達成タスク

対象の受入基準
- Cloud Run の `GET /api/health` が 200。
- Cloudflare Workers 配信のフロントから本番 API（Cloud Run）に対して最適化が成功し、CORS エラーがない。

本タスクでは、バックエンド（Cloud Run）とフロントエンド（Cloudflare Workers）の最小デプロイ、環境変数/CORS設定、動作確認手順を示す。

## 前提
- Google Cloud プロジェクトと課金が有効化済み（Cloud Run / Cloud Build / Artifact Registry 利用）。
- `gcloud` CLI セットアップ済み（`gcloud auth login`, `gcloud config set project <PROJECT_ID>`）。
- Cloudflare アカウントと Workers デプロイ権限、Wrangler CLI 利用可能（`npx wrangler --version`）。

## 作業タスク

### 1) バックエンドのコンテナ化（server/）
- [ ] `server/Dockerfile` を作成：

  ```dockerfile
  # server/Dockerfile
  FROM python:3.11-slim

  ENV PYTHONDONTWRITEBYTECODE=1 \
      PYTHONUNBUFFERED=1

  WORKDIR /app

  COPY requirements.txt /app/requirements.txt
  RUN pip install --no-cache-dir -r /app/requirements.txt \
      && pip install --no-cache-dir gunicorn

  COPY . /app

  # Cloud Run は $PORT を注入する。JSON 形式の CMD では環境変数展開しないため、sh -c でラップ。
  CMD ["sh", "-c", "exec gunicorn -b 0.0.0.0:$PORT -w 2 server.app:app"]
  ```

- [ ] ルートからビルド（server/ をビルドコンテキストに指定）：

  ```bash
  cd server
  gcloud builds submit --tag "gcr.io/route-chan/route-chan-api:latest" .
  ```

  備考: Artifact Registry を利用する場合は `LOCATION-docker.pkg.dev/PROJECT/REPO/IMAGE:TAG` を使用。

### 2) Cloud Run へデプロイと環境変数設定
- [ ] サービスをデプロイ（例: リージョン asia-northeast1）：

  ```bash
  gcloud run deploy route-chan-api \
    --image "gcr.io/route-chan/route-chan-api:latest" \
    --region asia-northeast1 \
    --platform managed \
    --allow-unauthenticated
  ```

- [ ] 環境変数を設定（OSRM は公開デモ、CORS は後で Workers のドメインを入れる）：

  ```bash
  gcloud run services update route-chan-api \
    --region asia-northeast1 \
    --update-env-vars "OSRM_BASE_URL=https://router.project-osrm.org,MAX_LOCATIONS=10,RATE_LIMIT_RULE=60/minute,SOLVER_TIME_LIMIT_MS=3000"
  ```

- [ ] Cloud Run の URL を控える（例: `https://route-chan-api-764884831659.asia-northeast1.run.app`）。

- [ ] ヘルスチェック確認：

  ```bash
  curl -fsS https://route-chan-api-764884831659.asia-northeast1.run.app/api/health
  # => {"status":"ok"}
  ```

### 3) CORS の本番設定（推奨）
現状の `server/app.py` は `origins="*"` で許可している。セキュリティ観点から本番は Cloudflare Workers のオリジンに限定する。

- [ ] `server/app.py` を以下のように変更（環境変数 `CORS_ALLOWED_ORIGINS` を参照）：

  ```python
  # server/app.py 抜粋
  import os
  from flask import Flask
  from flask_cors import CORS

  app = Flask(__name__)
  origins_env = os.getenv("CORS_ALLOWED_ORIGINS", "*")
  origins = [o.strip() for o in origins_env.split(",")] if origins_env else "*"
  CORS(app, resources={r"/api/*": {"origins": origins}})
  ```

- [ ] Cloud Run の環境変数に Cloudflare Workers の本番ドメインを設定：

  ```bash
  gcloud run services update route-chan-api \
    --region asia-northeast1 \
    --update-env-vars "CORS_ALLOWED_ORIGINS=https://route-chan-frontend.et-n-ogura.workers.dev"
  ```

  注: ワイルドカード許可（`*`）のままでも受入基準（CORS エラーなし）は満たせるが、原則はホワイトリストを推奨。

### 4) フロントエンドを Cloudflare Workers にデプロイ（assets 配信）
Workers の `assets` 機能で `dist` を配信する。`frontend/` ディレクトリで Worker を管理する前提。

- [ ] `frontend/` に Wrangler を導入（未導入の場合）

  ```bash
  cd frontend
  npm i -D wrangler
  ```

- [ ] `frontend/wrangler.toml` を作成

  ```toml
  name = "route-chan-frontend"
  main = "worker.ts"
  compatibility_date = "2024-05-01"

  assets = { directory = "./dist" }
  ```

- [ ] `frontend/worker.ts`（最小・SPA フォールバックあり）を作成

  ```ts
  export default {
    async fetch(request: Request, env: any): Promise<Response> {
      // まず静的アセットを試行
      const res = await env.ASSETS.fetch(request);
      if (res.status !== 404) return res;

      // ナビゲーション系（HTML）リクエストは index.html へフォールバック（SPA）
      const accept = request.headers.get("Accept") || "";
      if (accept.includes("text/html")) {
        const url = new URL(request.url);
        return env.ASSETS.fetch(new Request(new URL("/index.html", url).toString(), request));
      }
      return res;
    },
  } satisfies ExportedHandler;
  ```

- [ ] 本番 API を埋め込んでビルド → デプロイ

  ```bash
  cd frontend
  VITE_API_BASE_URL="https://route-chan-api-764884831659.asia-northeast1.run.app" npm run build
  npx wrangler deploy
  ```

  デプロイ完了時に表示される `*.workers.dev` の URL を控える。必要に応じてカスタムドメインを Cloudflare ダッシュボードからバインドする。

### 5) 受入基準の検証
- [ ] Cloud Run のヘルス確認（200）：

  ```bash
  curl -i https://route-chan-api-764884831659.asia-northeast1.run.app/api/health
  # HTTP/2 200 と {"status":"ok"}
  ```

- [ ] Cloudflare Workers（デプロイ先URL）を開き、以下を確認：
  - Depot と訪問地点（1点以上）を登録し「最適化を実行」。
  - Network タブで `POST https://route-chan-api-764884831659.asia-northeast1.run.app/api/optimize` が 200。CORS エラーがない。
  - ポリライン描画と距離/順序の表示を確認。

### 6) 補足（推奨設定）
- Cloud Run のメモリ/CPU/同時実行は要件に応じて調整（OR-Toolsを使用するため、CPU を 1〜2 vCPU 程度から検討）。
- `RATE_LIMIT_RULE` は公開環境の負荷を見ながら調整（例: `60/minute`）。
- OSRM デモは非保証のため、安定運用時は自前 OSRM の検討を継続。

## 受入基準チェック
- [ ] `https://route-chan-api-764884831659.asia-northeast1.run.app/api/health` が 200。
- [ ] Cloudflare Workers からの最適化が成功し、CORS エラーがない。

以上で、Plan の「5. デプロイ（MVP）」の受入基準を満たすための具体タスクを網羅する。
